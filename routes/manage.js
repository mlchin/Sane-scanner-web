const scan_doc_root="/home/pi/ScanDocuments/",fnsFile=require("./controllers");var express=require("express"),router=express.Router();router.get("/",(function(req,res,next){console.log("\n++ GET /manage");const directory=fnsFile.readFnsFile();res.render("manage",{title:"Manage Files",files:directory.files})})),router.post("/download",(function(req,res,next){console.log("\n++ POST /manage/download");const fs=require("fs");var filename=req.body.filename;const absFilename=scan_doc_root+filename,fileExt=filename.split(".")[1];if(fs.existsSync(absFilename)){var headerType="";headerType=-1!==["tiff","jpeg","png"].indexOf(fileExt)?"image/"+fileExt:"image/x-portable-anymap";const stat=fs.statSync(absFilename);"jpeg"===fileExt&&(filename=filename.split(".")[0]+".jpg"),res.set({"Content-Type":headerType,"Content-Disposition":"attachment; filename="+filename,"Content-Length":stat.size}),res.sendFile(absFilename,(function(err){err?console.log("++ ERROR: File aborted mid transfer. (BIG file). No error to webpage. Filename: "+absFilename):console.log("++ File successfully sent to client. Filename: "+absFilename)}))}})),router.post("/delete",(function(req,res,next){console.log("\n++ POST /manage/delete");const fs=require("fs");console.log("++POST /manage/delete");const filename=req.body.filename,absFilename=scan_doc_root+filename;if(fs.existsSync(absFilename))try{fs.unlinkSync(absFilename),console.log("++ File deleted: "+absFilename),fnsFile.writeFnsFile(),res.redirect("/manage")}catch(err){next(err)}else{const message="File "+filename+" not found. Unable to delete.";console.log(message),next(new Error(message))}})),module.exports=router;